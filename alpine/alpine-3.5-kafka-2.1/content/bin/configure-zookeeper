#!/bin/bash -e


# Configure Zookeeper Heap Options
ZOOKEEPER_CONF_HEAP_OPTS=${ZOOKEEPER_CONF_HEAP_OPTS:-"-Xms1G -Xmx2G"}
if [[ -n "$ZOOKEEPER_CONF_HEAP_OPTS" ]]; then
  sed -r -i "s/(export KAFKA_CONF_HEAP_OPTS)=\"(.*)\"/\1=\"$ZOOKEEPER_CONF_HEAP_OPTS\"/g" /opt/kafka/bin/zookeeper-server-start.sh
fi


# Configure Zookeeper Variable
ZOOKEEPER_CONF_DATA_DIRS="/data/zookeeper/data"
ZOOKEEPER_CONF_LOG_DIRS="/data/zookeeper/logs"
ZOOKEEPER_CONF_SERVER_COUNT=${ZOOKEEPER_CONF_SERVER_COUNT:-1}
ZOOKEEPER_CONF_SERVER_PORT=${ZOOKEEPER_CONF_SERVER_PORT:-2888}
ZOOKEEPER_CONF_ELECTION_PORT=${ZOOKEEPER_CONF_ELECTION_PORT:-3888}
ZOOKEEPER_CONF_CLIENT_PORT=${ZOOKEEPER_CONF_CLIENT_PORT:-2181}
ZOOKEEPER_CONF_TICK_TIME=${ZOOKEEPER_CONF_TICK_TIME:-2000}
ZOOKEEPER_CONF_INIT_LIMIT=${ZOOKEEPER_CONF_INIT_LIMIT:-10}
ZOOKEEPER_CONF_SYNC_LIMIT=${ZOOKEEPER_CONF_SYNC_LIMIT:-5}
ZOOKEEPER_CONF_MAX_CLIENT_CONNECTIONS=${ZOOKEEPER_CONF_MAX_CLIENT_CONNECTIONS:-0}
ZOOKEEPER_CONF_MIN_SESSION_TIMEOUT=${ZOOKEEPER_CONF_MIN_SESSION_TIMEOUT:-$((ZOOKEEPER_CONF_TICK_TIME*2))}
ZOOKEEPER_CONF_MAX_SESSION_TIMEOUT=${ZOOKEEPER_CONF_MAX_SESSION_TIMEOUT:-$((ZOOKEEPER_CONF_TICK_TIME*20))}
ZOOKEEPER_CONF_AUTO_PURGE_RETAIN_COUNT=${ZOOKEEPER_CONF_AUTO_PURGE_RETAIN_COUNT:-3}
ZOOKEEPER_CONF_AUTO_PURGE_INTERVAL=${ZOOKEEPER_CONF_AUTO_PURGE_INTERVAL:-0}

mkdir -p ${ZOOKEEPER_CONF_DATA_DIRS}
mkdir -p ${ZOOKEEPER_CONF_LOG_DIRS}

{ \
  echo "dataDir=${ZOOKEEPER_CONF_DATA_DIRS}"; \
  echo "dataLogDir=${ZOOKEEPER_CONF_LOG_DIRS}"; \
  echo ""; \
  echo "clientPort=${ZOOKEEPER_CONF_CLIENT_PORT}"; \
  echo ""; \
  echo "tickTime=${ZOOKEEPER_CONF_TICK_TIME}"; \
  echo "initLimit=${ZOOKEEPER_CONF_INIT_LIMIT}"; \
  echo "syncLimit=${ZOOKEEPER_CONF_SYNC_LIMIT}"; \
  echo ""; \
  echo "maxClientCnxns=${ZOOKEEPER_CONF_MAX_CLIENT_CONNECTIONS}"; \
  echo ""; \
  echo "minSessionTimeout=${ZOOKEEPER_CONF_MIN_SESSION_TIMEOUT}"; \
  echo "maxSessionTimeout=${ZOOKEEPER_CONF_MAX_SESSION_TIMEOUT}"; \
  echo ""; \
  echo "autopurge.snapRetainCount=${ZOOKEEPER_CONF_AUTO_PURGE_RETAIN_COUNT}"; \
  echo "autopurge.purgeInteval=${ZOOKEEPER_CONF_AUTO_PURGE_INTERVAL}"; \
  echo ""; \
} >> /opt/kafka/config/zookeeper.properties

if [ $ZOOKEEPER_CONF_SERVER_COUNT -gt 1 ]; then
  ZOOKEEPER_CONF_DOMAIN=`hostname -d`

  if [[ `hostname -s` =~ (.*)-([0-9]+)$ ]]; then
    ZOOKEEPER_CONF_SERVER_ID=${BASH_REMATCH[2]}
    ZOOKEEPER_CONF_HOST_NAME=${BASH_REMATCH[1]}

    ZOOKEEPER_CONF_SERVER_ID=$(($ZOOKEEPER_CONF_SERVER_ID+1))
    echo "${ZOOKEEPER_CONF_SERVER_ID}" > ${ZOOKEEPER_CONF_DATA_DIRS}/myid

    for (( ZOOKEEPER_CONF_SERVER_COUNT_LOOP=1; ZOOKEEPER_CONF_SERVER_COUNT_LOOP<=$ZOOKEEPER_CONF_SERVER_COUNT; ZOOKEEPER_CONF_SERVER_COUNT_LOOP++ ))
    do
      echo "server.${ZOOKEEPER_CONF_SERVER_COUNT_LOOP}=${ZOOKEEPER_CONF_HOST_NAME}-$(($ZOOKEEPER_CONF_SERVER_COUNT_LOOP-1)).${ZOOKEEPER_CONF_DOMAIN}:${ZOOKEEPER_CONF_SERVER_PORT}:${ZOOKEEPER_CONF_ELECTION_PORT}" >> /opt/kafka/config/zookeeper.properties
    done
    echo "" >> /opt/kafka/config/zookeeper.properties
  elif [[ `hostname -s` =~ (.*)_([0-9]+)$ ]]; then
    ZOOKEEPER_CONF_SERVER_ID=${BASH_REMATCH[2]}
    ZOOKEEPER_CONF_HOST_NAME=${BASH_REMATCH[1]}

    ZOOKEEPER_CONF_SERVER_ID=$(($ZOOKEEPER_CONF_SERVER_ID+1))
    echo "${ZOOKEEPER_CONF_SERVER_ID}" > ${ZOOKEEPER_CONF_DATA_DIRS}/myid

    for (( ZOOKEEPER_CONF_SERVER_COUNT_LOOP=1; ZOOKEEPER_CONF_SERVER_COUNT_LOOP<=$ZOOKEEPER_CONF_SERVER_COUNT; ZOOKEEPER_CONF_SERVER_COUNT_LOOP++ ))
    do
      echo "server.${ZOOKEEPER_CONF_SERVER_COUNT_LOOP}=${ZOOKEEPER_CONF_HOST_NAME}_$(($ZOOKEEPER_CONF_SERVER_COUNT_LOOP-1)).${ZOOKEEPER_CONF_DOMAIN}:${ZOOKEEPER_CONF_SERVER_PORT}:${ZOOKEEPER_CONF_ELECTION_PORT}" >> /opt/kafka/config/zookeeper.properties
    done
    echo "" >> /opt/kafka/config/zookeeper.properties
  fi
fi


# Cleaning-up Variables
unset ZOOKEEPER_CONF_HEAP_OPTS
unset ZOOKEEPER_CONF_DATA_DIRS ZOOKEEPER_CONF_DATA_LOG_DIRS
unset ZOOKEEPER_CONF_SERVER_COUNT ZOOKEEPER_CONF_SERVER_PORT ZOOKEEPER_CONF_ELECTION_PORT ZOOKEEPER_CONF_CLIENT_PORT
unset ZOOKEEPER_CONF_TICK_TIME ZOOKEEPER_CONF_INIT_LIMIT ZOOKEEPER_CONF_SYNC_LIMIT
unset ZOOKEEPER_CONF_MAX_CLIENT_CONNECTIONS
unset ZOOKEEPER_CONF_MIN_SESSION_TIMEOUT ZOOKEEPER_CONF_MAX_SESSION_TIMEOUT
unset ZOOKEEPER_CONF_AUTO_PURGE_RETAIN_COUNT ZOOKEEPER_CONF_AUTO_PURGE_INTERVAL
unset ZOOKEEPER_CONF_SERVER_ID ZOOKEEPER_CONF_HOST_NAME ZOOKEEPER_CONF_DOMAIN


exit 0
